name: Fotovoltaika Relay Control
on:
  schedule:
    # SpouÅ¡tÄ›t kaÅ¾dou hodinu ve 2. minutÄ› (cron format: minuta hodina den mÄ›sÃ­c den_v_tÃ½dnu)
    - cron: '2 * * * *'
  workflow_dispatch:
    # UmoÅ¾nit manuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­
  repository_dispatch:
    types: [run_fve]
jobs:
  run-fve-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Print current times (UTC and Europe/Prague)
      run: |
        echo "=== TIMING DEBUG ==="
        echo "UTC: $(date -u)"
        echo "Prague: $(TZ='Europe/Prague' date)"
        echo "Prague minute: $(TZ='Europe/Prague' date +%M)"
        echo "Expected: Every hour at minute 2 (Prague time)"
        echo "=================="

    # ZarovnÃ¡nÃ­ startu na :02 (Europe/Prague) pokud runner dorazil pÅ™edÄasnÄ›
    # GitHub Actions cron bÄ›Å¾Ã­ v UTC, takÅ¾e musÃ­me poÄkat na sprÃ¡vnÃ½ Äas v Praze
    - name: Align start to :02 (Europe/Prague)
      run: |
        PRAGUE_MIN=$(TZ='Europe/Prague' date +%M)
        PRAGUE_SEC=$(TZ='Europe/Prague' date +%S)
        echo "Current Prague time: $(TZ='Europe/Prague' date)"
        echo "Current Prague minute: $PRAGUE_MIN, second: $PRAGUE_SEC"
        
        if [ "$PRAGUE_MIN" -eq 1 ]; then
          # Pokud je :01, poÄkÃ¡me do :02
          SECS_TO_WAIT=$(( 60 - PRAGUE_SEC ))
          echo "Waiting $SECS_TO_WAIT seconds to reach :02 Europe/Prague"
          sleep $SECS_TO_WAIT
        elif [ "$PRAGUE_MIN" -eq 0 ]; then
          # Pokud je :00, poÄkÃ¡me 2 minuty
          SECS_TO_WAIT=$(( 120 - PRAGUE_SEC ))
          echo "Waiting $SECS_TO_WAIT seconds to reach :02 Europe/Prague"
          sleep $SECS_TO_WAIT
        else
          echo "Already past :02, running immediately"
        fi

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        echo "Installed packages:"
        pip list
        echo "Testing requests import:"
        python -c "import requests; print('requests imported successfully')"
        
    - name: Run FVE script
      env:
        SHELLY_AUTH_KEY: ${{ secrets.SHELLY_AUTH_KEY }}
        SHELLY_DEVICE_ID: ${{ secrets.SHELLY_DEVICE_ID }}
      run: |
        echo "ğŸš€ GitHub Actions workflow spuÅ¡tÄ›n"
        echo "â° ÄŒas spuÅ¡tÄ›nÃ­ (UTC): $(date -u)"
        echo "â° ÄŒas spuÅ¡tÄ›nÃ­ (Prague): $(TZ='Europe/Prague' date)"
        echo "ğŸ“… OÄekÃ¡vanÃ½ Äas: kaÅ¾dou hodinu ve 2. minutÄ›"
        echo "ğŸ” AktuÃ¡lnÃ­ minuta v Praze: $(TZ='Europe/Prague' date +%M)"
        echo "âœ… SprÃ¡vnÄ› spuÅ¡tÄ›no ve 2. minutÄ›: $([ $(TZ='Europe/Prague' date +%M) -eq 2 ] && echo "ANO" || echo "NE")"
        echo "ğŸ” SpouÅ¡tÃ­m main.py..."
        python main.py
